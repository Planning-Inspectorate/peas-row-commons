generator client {
  provider = "prisma-client"
  output   = "./client"

  engineType = "client"
  runtime    = "nodejs"
}

datasource db {
  provider = "sqlserver"
}

// NOTES
//
// use '//' comments for notes relevant to the schema
// use '///' comments for notes that should be included in the types definition
// see https://www.prisma.io/docs/concepts/components/prisma-schema#comments
//
// we use GUIDs for IDs (see https://learn.microsoft.com/en-us/sql/t-sql/data-types/uniqueidentifier-transact-sql?view=sql-server-ver16)
// this is because these IDs may be used in URLs and it makes them harder to guess
// while we don't rely on that for security, it adds an extra layer
// not everything needs this, but easier to make them all consistent and the increase in size (vs int) is negligible

/// Case represents a case in the system
model Case {
  /// internal identifier
  id                String         @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  createdDate       DateTime       @default(now())
  updatedDate       DateTime?
  receivedDate      DateTime
  closedDate        DateTime?
  /// type of case
  typeId            String
  Type              CaseType       @relation(fields: [typeId], references: [id])
  /// subtype of case
  subTypeId         String?
  SubType           CaseSubType?   @relation(fields: [subTypeId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  /// shown to users as a unique reference
  reference         String         @unique
  /// external identifier, optional unlike reference above
  externalReference String?
  name              String
  applicant         String?
  siteAddressId     String?        @db.UniqueIdentifier
  SiteAddress       Address?       @relation(fields: [siteAddressId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  authority         String?
  area              String?
  /// Entra ID
  caseOfficerId     String
  procedureId       String?
  Procedure         CaseProcedure? @relation(fields: [procedureId], references: [id])
  linkedCases       String?
  Dates             CaseDates?
  /// Physical location of real-world files
  filesLocation     String?
  Folders           Folder[]
  Costs             CaseCosts?
}

model CaseworkArea {
  /// unique machine-readable name, not generated
  id          String     @id
  displayName String?
  caseTypes   CaseType[]
}

/// CaseType represents types of cases we receive
model CaseType {
  /// unique machine-readable name, not generated
  id             String        @id
  displayName    String?
  Case           Case[]
  SubTypes       CaseSubType[]
  caseworkAreaId String
  CaseworkArea   CaseworkArea  @relation(fields: [caseworkAreaId], references: [id], onDelete: NoAction)
}

/// CaseSubType represents subtypes of cases we receive
model CaseSubType {
  /// unique machine-readable name, not generated
  id           String   @id
  displayName  String?
  Case         Case[]
  parentTypeId String
  ParentType   CaseType @relation(fields: [parentTypeId], references: [id])
}

/// CaseProcedure represents the procedure type a case will follow
model CaseProcedure {
  /// unique machine-readable name, not generated, e.g. "inquiry"
  id          String  @id
  displayName String?
  Case        Case[]
}

/// Address represents an address of a property or place
model Address {
  /// internal identifier
  id       String  @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  line1    String?
  line2    String?
  townCity String?
  county   String?
  postcode String?
  Case     Case[]
}

/// Dates that are associated with a case, a couple more generic ones are
/// kept on the main Case table (e.g. createdDate)
model CaseDates {
  id                                      String    @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  /// The project start date.
  startDate                               DateTime?
  /// The date that the objection period ends
  objectionPeriodEndsDate                 DateTime?
  /// When it is expected that the case will be submitted
  expectedSubmissionDate                  DateTime?
  /// Date feedback via written representation is submitted
  offerForWrittenRepresentationDate       DateTime?
  /// Date offer for consent ends
  consentDeadlineDate                     DateTime?
  /// A target date for an envement
  targetEventDate                         DateTime?
  /// Due date for Other Government Departments (OGD)
  ogdDueDate                              DateTime?
  /// Date proposal letter sent to e.g. Secretary of State
  proposalLetterDate                      DateTime?
  /// Date the case expires
  expiryDate                              DateTime?
  /// Date parties sent a deadline notification
  partiesEventNotificationDeadlineDate    DateTime?
  /// Date parties sent an event notification
  partiesDecisionNotificationDeadlineDate DateTime?
  caseId                                  String    @unique @db.UniqueIdentifier
  Case                                    Case      @relation(fields: [caseId], references: [id])
}

/// Folder model
/// Contains folders created for each case that will contain documents.
model Folder {
  id             String    @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  displayName    String
  displayOrder   Int?
  parentFolderId String?   @db.UniqueIdentifier
  caseId         String?   @db.UniqueIdentifier
  isCustom       Boolean   @default(false)
  deletedAt      DateTime?
  Case           Case?     @relation(fields: [caseId], references: [id])
  ParentFolder   Folder?   @relation("FolderTree", fields: [parentFolderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ChildFolders   Folder[]  @relation("FolderTree")

  @@unique([caseId, displayName, parentFolderId, deletedAt])
}

model CaseCosts {
  id           String   @id @default(dbgenerated("newid()")) @db.UniqueIdentifier
  rechargeable Boolean?
  finalCost    Decimal?
  feeReceived  Boolean?
  /// Whether the invoice has been sent.
  /// One of 'YES', 'NO', 'INTERIM', as there is no ENUM in SQL Server.
  invoiceSent  String?
  caseId       String   @unique @db.UniqueIdentifier
  Case         Case     @relation(fields: [caseId], references: [id])
}
